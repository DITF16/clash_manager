<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clash é…ç½®ç®¡ç†å™¨</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Clash é…ç½®ç®¡ç†å™¨</h1>
        
        <!-- è®¢é˜…æ›´æ–°åŒºåŸŸ -->
        <div class="card">
            <h2>ğŸ“¡ è®¢é˜…ç®¡ç†</h2>
            <div class="form-group">
                <input type="text" id="subscriptionUrl" placeholder="è¾“å…¥è®¢é˜… URL">
                <button onclick="refreshSubscription()" class="btn btn-primary">æ›´æ–°è®¢é˜…</button>
                <button onclick="exportConfig()" class="btn btn-success">å¯¼å‡ºé…ç½®</button>
            </div>
            
            <!-- ä¿®æ”¹æ–‡ä»¶ç®¡ç† -->
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <h3 style="flex: 1; margin: 0;">ğŸ’¾ ä¿®æ”¹æ–‡ä»¶ç®¡ç†</h3>
                    <button onclick="showSaveModificationModal()" class="btn btn-primary">ä¿å­˜å½“å‰ä¿®æ”¹</button>
                </div>
                <div id="modificationsList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px;"></div>
            </div>
        </div>
        
        <!-- ä»£ç†ç»„ç®¡ç† -->
        <div class="card">
            <h2>ğŸ“¦ ä»£ç†ç»„ç®¡ç†</h2>
            <button onclick="showAddGroupModal()" class="btn btn-primary">æ·»åŠ ä»£ç†ç»„</button>
            <div id="proxyGroupsList" class="list-container"></div>
        </div>
        
        <!-- è§„åˆ™ç®¡ç† -->
        <div class="card">
            <h2>ğŸ“‹ è§„åˆ™ç®¡ç†</h2>
            <div class="rule-header">
                <div class="search-container">
                    <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    <input type="text" id="ruleSearch" placeholder="æœç´¢è§„åˆ™ï¼ˆåŸŸå/IPï¼‰..." class="rule-search-input" oninput="filterRules()">
                </div>
                <div class="filter-container">
                    <svg class="filter-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M4 6h16v2H4zm2 5h12v2H6zm4 5h4v2h-4z"></path>
                    </svg>
                    <select id="ruleTypeFilter" onchange="filterRules()" class="rule-type-select">
                        <option value="">å…¨éƒ¨ç±»å‹</option>
                        <option value="DOMAIN-SUFFIX">ğŸŒ DOMAIN-SUFFIX</option>
                        <option value="DOMAIN">ğŸ“Œ DOMAIN</option>
                        <option value="DOMAIN-KEYWORD">ğŸ” DOMAIN-KEYWORD</option>
                        <option value="IP-CIDR">ğŸ”¢ IP-CIDR</option>
                        <option value="IP-CIDR6">ğŸ”¢ IP-CIDR6</option>
                    </select>
                </div>
                <button onclick="showAddRuleModal()" class="btn btn-primary btn-add-rule">
                    <svg viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px; margin-right: 6px;">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path>
                    </svg>
                    æ·»åŠ è§„åˆ™
                </button>
            </div>
            <div class="rule-stats">
                <span class="stats-item">
                    <span class="stats-label">æ€»è®¡:</span>
                    <span class="stats-value" id="totalCount">0</span>
                </span>
                <span class="stats-item">
                    <span class="stats-label">æ˜¾ç¤º:</span>
                    <span class="stats-value" id="showingCount">0</span>
                </span>
            </div>
            <div id="rulesList" class="list-container"></div>
            <div id="rulePagination" class="pagination"></div>
        </div>
    </div>
    
    <!-- ä»£ç†ç»„æ¨¡æ€æ¡† -->
    <div id="groupModal" class="modal">
        <div class="modal-content modal-large">
            <span class="close" onclick="closeModal('groupModal')">&times;</span>
            <h3 id="groupModalTitle">æ·»åŠ ä»£ç†ç»„</h3>
            <form id="groupForm">
                <input type="hidden" id="groupOldName">
                <div class="form-row">
                    <div class="form-group">
                        <label>åç§°:</label>
                        <input type="text" id="groupName" required>
                    </div>
                    <div class="form-group">
                        <label>ç±»å‹:</label>
                        <select id="groupType" onchange="toggleUrlTestOptions()">
                            <option value="select">select</option>
                            <option value="url-test">url-test</option>
                        </select>
                    </div>
                </div>
                <div id="urlTestOptions" class="url-test-options" style="display:none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>æµ‹è¯• URL:</label>
                            <input type="text" id="groupUrl" value="http://www.gstatic.com/generate_204">
                        </div>
                        <div class="form-group">
                            <label>é—´éš”(ç§’):</label>
                            <input type="number" id="groupInterval" value="300">
                        </div>
                        <div class="form-group">
                            <label>å®¹å·®(ms):</label>
                            <input type="number" id="groupTolerance" value="50">
                        </div>
                    </div>
                </div>
                
<!-- ä»£ç†èŠ‚ç‚¹é€‰æ‹©åŒºåŸŸ -->
                <div class="form-group">
                    <label>ä»£ç†èŠ‚ç‚¹:</label>
                    <div class="proxy-selector">
                        <div class="proxy-available">
                            <div class="proxy-tabs">
                                <button type="button" class="tab-btn active" onclick="switchProxyTab('nodes')">èŠ‚ç‚¹</button>
                                <button type="button" class="tab-btn" onclick="switchProxyTab('groups')">ä»£ç†ç»„</button>
                            </div>
                            <div id="nodesTab" class="tab-content">
                                <h4>å¯ç”¨èŠ‚ç‚¹ <span id="availableCount">(0)</span></h4>
                                <input type="text" class="search-input" placeholder="æœç´¢èŠ‚ç‚¹..." oninput="filterAvailableProxies()">
                                <div id="availableProxies" class="proxy-list"></div>
                            </div>
                            <div id="groupsTab" class="tab-content" style="display:none;">
                                <h4>å¯ç”¨ä»£ç†ç»„ <span id="availableGroupsCount">(0)</span></h4>
                                <input type="text" class="search-input" placeholder="æœç´¢ä»£ç†ç»„..." oninput="filterAvailableGroups()">
                                <div id="availableGroups" class="proxy-list"></div>
                            </div>
                        </div>
                        <div class="proxy-actions">
                            <button type="button" class="btn btn-sm" onclick="addSelectedProxies()">â†’ æ·»åŠ </button>
                            <button type="button" class="btn btn-sm" onclick="addAllProxies()">Â» å…¨éƒ¨æ·»åŠ </button>
                            <button type="button" class="btn btn-sm" onclick="removeSelectedProxies()">â† ç§»é™¤</button>
                            <button type="button" class="btn btn-sm" onclick="clearAllProxies()">Â« æ¸…ç©º</button>
                        </div>
                        <div class="proxy-selected">
                            <h4>å·²é€‰èŠ‚ç‚¹ <span id="selectedCount">(0)</span></h4>
                            <input type="text" class="search-input" placeholder="æœç´¢å·²é€‰..." oninput="filterSelectedProxies()">
                            <div id="selectedProxies" class="proxy-list"></div>
                        </div>
                    </div>
                </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                    <button type="button" class="btn" onclick="closeModal('groupModal')">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- è§„åˆ™æ¨¡æ€æ¡† -->
    <div id="ruleModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('ruleModal')">&times;</span>
            <h3 id="ruleModalTitle">æ·»åŠ è§„åˆ™</h3>
            <form id="ruleForm">
                <input type="hidden" id="ruleIndex">
                <div class="form-group">
                    <label>ç±»å‹:</label>
                    <select id="ruleType">
                        <option value="DOMAIN-SUFFIX">DOMAIN-SUFFIX</option>
                        <option value="DOMAIN">DOMAIN</option>
                        <option value="DOMAIN-KEYWORD">DOMAIN-KEYWORD</option>
                        <option value="IP-CIDR">IP-CIDR</option>
                        <option value="IP-CIDR6">IP-CIDR6</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å€¼:</label>
                    <input type="text" id="ruleValue" required placeholder="åŸŸåæˆ– IP æ®µ">
                </div>
                <div class="form-group">
                    <label>ä»£ç†ç»„:</label>
                    <select id="ruleProxy"></select>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="ruleNoResolve"> 
                        <span>no-resolve (ä¸è§£æ DNS)</span>
                    </label>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                    <button type="button" class="btn" onclick="closeModal('ruleModal')">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- æ‰¹é‡æ“ä½œæç¤º -->
    
    <!-- ä¿å­˜ä¿®æ”¹æ¨¡æ€æ¡† -->
    <div id="saveModificationModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('saveModificationModal')">&times;</span>
            <h3>ä¿å­˜å½“å‰ä¿®æ”¹</h3>
            <form id="saveModificationForm">
                <div class="form-group">
                    <label>ä¿®æ”¹åç§°:</label>
                    <input type="text" id="modificationName" required placeholder="ä¾‹å¦‚ï¼šæ·»åŠ å›½å¤–åª’ä½“è§„åˆ™">
                </div>
                <div class="form-group">
                    <label>ä¿®æ”¹æè¿°:</label>
                    <textarea id="modificationDescription" placeholder="æè¿°è¿™ä¸ªä¿®æ”¹çš„å†…å®¹å’Œç›®çš„..." style="min-height: 80px;"></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">ä¿å­˜ä¿®æ”¹</button>
                    <button type="button" class="btn" onclick="closeModal('saveModificationModal')">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>
    

    <div id="toast" class="toast"></div>
</body>
</html>

<script>
    let allProxies = [];
    let allGroups = [];
    let allRules = [];
    let filteredRules = [];
    let selectedProxies = [];
    let currentPage = 1;
    const rulesPerPage = 20;
    
    // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
    document.addEventListener('DOMContentLoaded', function() {
        loadProxies();
        loadProxyGroups();
        loadModifications();

        loadRules();
    });
    
    async function loadProxies() {
        const res = await fetch('/api/proxies');
        const data = await res.json();
        allProxies = data.proxies;
        renderAvailableProxies();
        updateRuleProxySelect();
    }
    
    async function loadProxyGroups() {
        const res = await fetch('/api/proxy-groups');
        const data = await res.json();
        allGroups = data['proxy-groups'];
        renderProxyGroups();
        updateRuleProxySelect();
    }
    
    async function loadRules() {
        const res = await fetch('/api/rules');
        const data = await res.json();
        allRules = data.rules;
        filteredRules = [...allRules];
        document.getElementById('totalCount').textContent = allRules.length;
        currentPage = 1;
        renderRules();
    }
    
    function updateRuleProxySelect() {
        const ruleProxy = document.getElementById('ruleProxy');
        ruleProxy.innerHTML = allGroups.map(g => 
            `<option value="${g.name}">${g.name}</option>`
        ).join('');
    }
    
    // ==================== ä»£ç†ç»„æ¸²æŸ“ ====================
    function renderProxyGroups() {
        const container = document.getElementById('proxyGroupsList');
        if (allGroups.length === 0) {
            container.innerHTML = '<div class="empty-state">æš‚æ— ä»£ç†ç»„ï¼Œç‚¹å‡»"æ·»åŠ ä»£ç†ç»„"åˆ›å»º</div>';
            return;
        }
        container.innerHTML = allGroups.map((g, i) => `
            <div class="list-item">
                <div class="item-info">
                    <strong class="group-name">${g.name}</strong>
                    <span class="badge">${g.type}</span>
                    <span class="proxy-count">ğŸ“Œ ${g.proxies?.length || 0} ä¸ªèŠ‚ç‚¹</span>
                    ${g.type === 'url-test' ? `<span class="badge badge-info">URL: ${g.url || 'default'}</span>` : ''}
                </div>
                <div class="item-actions">
                    <button onclick="editGroup(${i})" class="btn btn-sm btn-primary">ç¼–è¾‘</button>
                    <button onclick="duplicateGroup(${i})" class="btn btn-sm btn-info">å¤åˆ¶</button>
                    <button onclick="deleteGroup('${g.name}')" class="btn btn-sm btn-danger">åˆ é™¤</button>
                </div>
            </div>
        `).join('');
    }
    
    // ==================== ä»£ç†èŠ‚ç‚¹é€‰æ‹©å™¨ ====================
    function renderAvailableProxies(filter = '') {
        const container = document.getElementById('availableProxies');
        const filtered = allProxies.filter(p => 
            p.toLowerCase().includes(filter.toLowerCase()) && 
            !selectedProxies.includes(p)
        );
        document.getElementById('availableCount').textContent = `(${filtered.length})`;
        
        if (filtered.length === 0) {
            container.innerHTML = '<div class="empty-state">æ— å¯ç”¨èŠ‚ç‚¹</div>';
            return;
        }
        
        container.innerHTML = filtered.map(p => `
            <div class="proxy-item" data-proxy="${p}">
                <input type="checkbox" class="proxy-checkbox" value="${p}">
                <span class="proxy-name">${p}</span>
            </div>
        `).join('');
    }
    
    function renderSelectedProxies(filter = '') {
        const container = document.getElementById('selectedProxies');
        const filtered = selectedProxies.filter(p => 
            p.toLowerCase().includes(filter.toLowerCase())
        );
        document.getElementById('selectedCount').textContent = `(${filtered.length})`;
        
        if (filtered.length === 0) {
            container.innerHTML = '<div class="empty-state">è¯·é€‰æ‹©èŠ‚ç‚¹</div>';
            return;
        }
        
        container.innerHTML = filtered.map((p, i) => `
            <div class="proxy-item selected" data-proxy="${p}">
                <span class="proxy-index">${i + 1}.</span>
                <span class="proxy-name">${p}</span>
                <button type="button" class="btn-remove" onclick="removeProxy('${p}')">Ã—</button>
                <button type="button" class="btn-move" onclick="moveProxyUp('${p}')">â†‘</button>
                <button type="button" class="btn-move" onclick="moveProxyDown('${p}')">â†“</button>
            </div>
        `).join('');
    }
    
    function filterAvailableProxies() {
        const filter = event.target.value;
        renderAvailableProxies(filter);
    }
    
function filterSelectedProxies() {
         const filter = event.target.value;
         renderSelectedProxies(filter);
     }
     
     // ==================== æ ‡ç­¾é¡µåˆ‡æ¢ ====================
     function switchProxyTab(tab) {
         const nodeTab = document.getElementById('nodesTab');
         const groupTab = document.getElementById('groupsTab');
         const btns = document.querySelectorAll('.tab-btn');
         
         btns.forEach(b => b.classList.remove('active'));
         
         if (tab === 'nodes') {
             nodeTab.style.display = 'block';
             groupTab.style.display = 'none';
             btns[0].classList.add('active');
         } else {
             nodeTab.style.display = 'none';
             groupTab.style.display = 'block';
             btns[1].classList.add('active');
             renderAvailableGroups();
         }
     }
     
     // ==================== ä»£ç†ç»„é€‰æ‹©å™¨ ====================
     function renderAvailableGroups(filter = '') {
         const container = document.getElementById('availableGroups');
         // æ’é™¤å½“å‰ç¼–è¾‘çš„ä»£ç†ç»„ï¼ˆå¦‚æœæœ‰ï¼‰
         const currentGroup = document.getElementById('groupOldName').value;
         const filtered = allGroups.filter(g => 
             g.name.toLowerCase().includes(filter.toLowerCase()) && 
             !selectedProxies.includes(g.name) &&
             g.name !== currentGroup
         );
         document.getElementById('availableGroupsCount').textContent = `(${filtered.length})`;
         
         if (filtered.length === 0) {
             container.innerHTML = '<div class="empty-state">æ— å¯ç”¨ä»£ç†ç»„</div>';
             return;
         }
         
         container.innerHTML = filtered.map(g => `
             <div class="proxy-item group-item" data-proxy="${g.name}">
                 <input type="checkbox" class="proxy-checkbox" value="${g.name}">
                 <span class="proxy-name">${g.name}</span>
                 <span class="group-badge">${g.proxies?.length || 0}ä¸ª</span>
             </div>
         `).join('');
     }
     
     function filterAvailableGroups() {
         const filter = event.target.value;
         renderAvailableGroups(filter);
     }
    
function addSelectedProxies() {
         const currentTab = document.getElementById('nodesTab').style.display === 'none' ? 'groups' : 'nodes';
         
         if (currentTab === 'nodes') {
             // æ·»åŠ èŠ‚ç‚¹
             const checkboxes = document.querySelectorAll('#availableProxies .proxy-checkbox:checked');
             checkboxes.forEach(cb => {
                 if (!selectedProxies.includes(cb.value)) {
                     selectedProxies.push(cb.value);
                 }
             });
         } else {
             // æ·»åŠ ä»£ç†ç»„
             const checkboxes = document.querySelectorAll('#availableGroups .proxy-checkbox:checked');
             checkboxes.forEach(cb => {
                 if (!selectedProxies.includes(cb.value)) {
                     selectedProxies.push(cb.value);
                 }
             });
         }
         
         renderAvailableProxies();
         renderAvailableGroups();
         renderSelectedProxies();
     }
    
function addAllProxies() {
         const currentTab = document.getElementById('nodesTab').style.display === 'none' ? 'groups' : 'nodes';
         
         if (currentTab === 'nodes') {
             // æ·»åŠ æ‰€æœ‰èŠ‚ç‚¹
             const available = allProxies.filter(p => !selectedProxies.includes(p));
             selectedProxies = [...selectedProxies, ...available];
         } else {
             // æ·»åŠ æ‰€æœ‰ä»£ç†ç»„
             const available = allGroups.filter(g => !selectedProxies.includes(g.name));
             selectedProxies = [...selectedProxies, ...available.map(g => g.name)];
         }
         
         renderAvailableProxies();
         renderAvailableGroups();
         renderSelectedProxies();
     }
    
function removeSelectedProxies() {
         const checkboxes = document.querySelectorAll('#selectedProxies .proxy-checkbox:checked');
         checkboxes.forEach(cb => {
             selectedProxies = selectedProxies.filter(p => p !== cb.value);
         });
         renderAvailableProxies();
         renderAvailableGroups();
         renderSelectedProxies();
     }
    
function clearAllProxies() {
         selectedProxies = [];
         renderAvailableProxies();
         renderAvailableGroups();
         renderSelectedProxies();
     }
    
function removeProxy(name) {
         selectedProxies = selectedProxies.filter(p => p !== name);
         renderAvailableProxies();
         renderAvailableGroups();
         renderSelectedProxies();
     }
    
    function moveProxyUp(name) {
        const index = selectedProxies.indexOf(name);
        if (index > 0) {
            [selectedProxies[index], selectedProxies[index - 1]] = 
            [selectedProxies[index - 1], selectedProxies[index]];
            renderSelectedProxies();
        }
    }
    
    function moveProxyDown(name) {
        const index = selectedProxies.indexOf(name);
        if (index < selectedProxies.length - 1) {
            [selectedProxies[index], selectedProxies[index + 1]] = 
            [selectedProxies[index + 1], selectedProxies[index]];
            renderSelectedProxies();
        }
    }
    
    // ==================== è§„åˆ™ç®¡ç† ====================
    function filterRules() {
        const search = document.getElementById('ruleSearch').value.toLowerCase();
        const typeFilter = document.getElementById('ruleTypeFilter').value;
        
        filteredRules = allRules.filter(r => {
            const parts = r.split(',');
            const matchSearch = r.toLowerCase().includes(search);
            const matchType = !typeFilter || parts[0] === typeFilter;
            return matchSearch && matchType;
        });
        
        document.getElementById('showingCount').textContent = filteredRules.length;
        currentPage = 1;
        renderRules();
    }
    
    function renderRules() {
        const container = document.getElementById('rulesList');
        const start = (currentPage - 1) * rulesPerPage;
        const end = start + rulesPerPage;
        const pageRules = filteredRules.slice(start, end);
        
        if (pageRules.length === 0) {
            container.innerHTML = '<div class="empty-state">æš‚æ— è§„åˆ™ï¼Œç‚¹å‡»"æ·»åŠ è§„åˆ™"åˆ›å»º</div>';
            renderPagination();
            return;
        }
        
        container.innerHTML = pageRules.map((r, localIndex) => {
            const globalIndex = start + localIndex;
            const parts = r.split(',');
            return `
                <div class="list-item rule-item">
                    <div class="item-info">
                        <span class="badge badge-${getRuleTypeColor(parts[0])}">${parts[0]}</span>
                        <code class="rule-value">${parts[1]}</code>
                        <span class="rule-arrow">â†’</span>
                        <span class="rule-proxy">${parts[2]}</span>
                        ${parts[3] ? '<span class="badge badge-info">no-resolve</span>' : ''}
                    </div>
                    <div class="item-actions">
                        <button onclick="editRule(${globalIndex})" class="btn btn-sm btn-primary">ç¼–è¾‘</button>
                        <button onclick="moveRuleUp(${globalIndex})" class="btn btn-sm" title="ä¸Šç§»">â†‘</button>
                        <button onclick="moveRuleDown(${globalIndex})" class="btn btn-sm" title="ä¸‹ç§»">â†“</button>
                        <button onclick="deleteRule(${globalIndex})" class="btn btn-sm btn-danger">åˆ é™¤</button>
                    </div>
                </div>
            `;
        }).join('');
        
        renderPagination();
    }
    
    function getRuleTypeColor(type) {
        const colors = {
            'DOMAIN-SUFFIX': 'primary',
            'DOMAIN': 'success',
            'DOMAIN-KEYWORD': 'warning',
            'IP-CIDR': 'danger',
            'IP-CIDR6': 'info'
        };
        return colors[type] || 'primary';
    }
    
    function renderPagination() {
        const totalPages = Math.ceil(filteredRules.length / rulesPerPage);
        const container = document.getElementById('rulePagination');
        
        if (totalPages <= 1) {
            container.innerHTML = '';
            return;
        }
        
        let html = '<div class="pagination-buttons">';
        html += `<button onclick="changePage(1)" ${currentPage === 1 ? 'disabled' : ''}>é¦–é¡µ</button>`;
        html += `<button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>`;
        
        for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
            html += `<button onclick="changePage(${i})" class="${i === currentPage ? 'active' : ''}">${i}</button>`;
        }
        
        html += `<button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>`;
        html += `<button onclick="changePage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>æœ«é¡µ</button>`;
        html += '</div>';
        
        container.innerHTML = html;
    }
    
    function changePage(page) {
        const totalPages = Math.ceil(filteredRules.length / rulesPerPage);
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        renderRules();
    }
    
    async function moveRuleUp(index) {
        if (index <= 0) return;
        const res = await fetch('/api/rules/move', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({index, direction: 'up'})
        });
        const result = await res.json();
        if (result.success) loadRules();
    }
    
    async function moveRuleDown(index) {
        if (index >= allRules.length - 1) return;
        const res = await fetch('/api/rules/move', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({index, direction: 'down'})
        });
        const result = await res.json();
        if (result.success) loadRules();
    }
    
    // ==================== æ¨¡æ€æ¡†æ“ä½œ ====================
    function toggleUrlTestOptions() {
        const type = document.getElementById('groupType').value;
        document.getElementById('urlTestOptions').style.display = 
            type === 'url-test' ? 'block' : 'none';
    }
    
    function showAddGroupModal() {
        selectedProxies = [];
        document.getElementById('groupModalTitle').textContent = 'æ·»åŠ ä»£ç†ç»„';
        document.getElementById('groupForm').reset();
        document.getElementById('groupOldName').value = '';
        document.getElementById('groupType').value = 'select';
        toggleUrlTestOptions();
        renderAvailableProxies();
        renderSelectedProxies();
        document.getElementById('groupModal').style.display = 'block';
    }
    
    function editGroup(index) {
        const g = allGroups[index];
        selectedProxies = [...(g.proxies || [])];
        document.getElementById('groupModalTitle').textContent = 'ç¼–è¾‘ä»£ç†ç»„';
        document.getElementById('groupOldName').value = g.name;
        document.getElementById('groupName').value = g.name;
        document.getElementById('groupType').value = g.type;
        document.getElementById('groupUrl').value = g.url || 'http://www.gstatic.com/generate_204';
        document.getElementById('groupInterval').value = g.interval || 300;
        document.getElementById('groupTolerance').value = g.tolerance || 50;
        toggleUrlTestOptions();
        renderAvailableProxies();
        renderSelectedProxies();
        document.getElementById('groupModal').style.display = 'block';
    }
    
    async function duplicateGroup(index) {
        const g = allGroups[index];
        const newName = g.name + ' (copy)';
        const data = {
            name: newName,
            type: g.type,
            proxies: [...(g.proxies || [])]
        };
        if (g.type === 'url-test') {
            data.url = g.url;
            data.interval = g.interval;
            data.tolerance = g.tolerance;
        }
        
        const res = await fetch('/api/proxy-groups/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        const result = await res.json();
        showToast(result.message);
        if (result.success) loadProxyGroups();
    }
    
    function showAddRuleModal() {
        document.getElementById('ruleModalTitle').textContent = 'æ·»åŠ è§„åˆ™';
        document.getElementById('ruleForm').reset();
        document.getElementById('ruleIndex').value = '';
        document.getElementById('ruleModal').style.display = 'block';
    }
    
    function editRule(index) {
        const r = allRules[index].split(',');
        document.getElementById('ruleModalTitle').textContent = 'ç¼–è¾‘è§„åˆ™';
        document.getElementById('ruleIndex').value = index;
        document.getElementById('ruleType').value = r[0];
        document.getElementById('ruleValue').value = r[1];
        document.getElementById('ruleProxy').value = r[2];
        document.getElementById('ruleNoResolve').checked = r[3] === 'no-resolve';
        document.getElementById('ruleModal').style.display = 'block';
    }
    
    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
    }
    
    // ==================== è¡¨å•æäº¤ ====================
    document.getElementById('groupForm').onsubmit = async function(e) {
        e.preventDefault();
        const data = {
            name: document.getElementById('groupName').value,
            old_name: document.getElementById('groupOldName').value,
            type: document.getElementById('groupType').value,
            proxies: selectedProxies
        };
        
        if (data.type === 'url-test') {
            data.url = document.getElementById('groupUrl').value;
            data.interval = parseInt(document.getElementById('groupInterval').value);
            data.tolerance = parseInt(document.getElementById('groupTolerance').value);
        }
        
        const url = data.old_name ? '/api/proxy-groups/update' : '/api/proxy-groups/add';
        const res = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        const result = await res.json();
        showToast(result.message);
        if (result.success) {
            closeModal('groupModal');
            loadProxyGroups();
        }
    };
    
    document.getElementById('ruleForm').onsubmit = async function(e) {
        e.preventDefault();
        const data = {
            type: document.getElementById('ruleType').value,
            value: document.getElementById('ruleValue').value,
            proxy: document.getElementById('ruleProxy').value,
            no_resolve: document.getElementById('ruleNoResolve').checked
        };
        
        const index = document.getElementById('ruleIndex').value;
        if (index !== '') {
            data.index = parseInt(index);
        }
        
        const url = index !== '' ? '/api/rules/update' : '/api/rules/add';
        const res = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        const result = await res.json();
        showToast(result.message);
        if (result.success) {
            closeModal('ruleModal');
            loadRules();
        }
    };
    
    // ==================== åˆ é™¤æ“ä½œ ====================
    async function deleteGroup(name) {
        if (!confirm(`ç¡®å®šåˆ é™¤ä»£ç†ç»„ "${name}"ï¼Ÿ`)) return;
        const res = await fetch('/api/proxy-groups/delete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name})
        });
        const result = await res.json();
        showToast(result.message);
        loadProxyGroups();
    }
    
    async function deleteRule(index) {
        if (!confirm('ç¡®å®šåˆ é™¤è¯¥è§„åˆ™ï¼Ÿ')) return;
        const res = await fetch('/api/rules/delete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({index})
        });
        const result = await res.json();
        showToast(result.message);
        loadRules();
    }
    
    // ==================== è®¢é˜…å’Œå¯¼å‡º ====================
    async function refreshSubscription() {
        const url = document.getElementById('subscriptionUrl').value;
        if (!url) {
            showToast('è¯·è¾“å…¥è®¢é˜… URL', 'error');
            return;
        }
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = 'æ›´æ–°ä¸­...';
        
        const res = await fetch('/api/config/refresh', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({subscription_url: url})
        });
        const result = await res.json();
        showToast(result.message);
        btn.disabled = false;
        btn.textContent = 'æ›´æ–°è®¢é˜…';
        
        if (result.success) {
            loadProxies();
            loadProxyGroups();
            loadRules();
        }
    }
    
    async function exportConfig() {
        const res = await fetch('/api/config/export');
        const data = await res.json();
        const blob = new Blob([data.config], {type: 'text/yaml'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `clash_config_${new Date().toISOString().slice(0,10)}.yaml`;
        a.click();
        showToast('é…ç½®å·²å¯¼å‡º');
    }
    
    // ==================== å·¥å…·å‡½æ•° ====================
    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = `toast show toast-${type}`;
        setTimeout(() => toast.className = 'toast', 3000);
    }
    
    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    }
    
    
    // ==================== ä¿®æ”¹æ–‡ä»¶ç®¡ç† ====================
    async function loadModifications() {
        try {
            const res = await fetch('/api/modifications/list');
            const data = await res.json();
            if (data.success) {
                renderModifications(data.modifications);
            }
        } catch (error) {
            console.error('åŠ è½½ä¿®æ”¹æ–‡ä»¶å¤±è´¥:', error);
        }
    }
    
    function renderModifications(modifications) {
        const container = document.getElementById('modificationsList');
        if (modifications.length === 0) {
            container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #999;">æš‚æ— ä¿å­˜çš„ä¿®æ”¹</p>';
            return;
        }
        
        container.innerHTML = modifications.map(mod => `
            <div style="background: #f5f5f5; border-radius: 8px; padding: 12px; border-left: 4px solid #667eea;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                    <div>
                        <h4 style="margin: 0 0 4px 0; color: #333;">${mod.name}</h4>
                        <p style="margin: 0; font-size: 12px; color: #999;">${new Date(mod.created_at).toLocaleString()}</p>
                    </div>
                    <button onclick="deleteModification('${mod.filename}')" class="btn btn-sm" style="background: #ff6b6b; color: white; border: none; padding: 4px 8px; cursor: pointer;">åˆ é™¤</button>
                </div>
                <p style="margin: 8px 0; font-size: 13px; color: #666; line-height: 1.4;">${mod.description || 'æ— æè¿°'}</p>
                <button onclick="applyModification('${mod.filename}')" class="btn btn-primary" style="width: 100%; margin-top: 8px;">åº”ç”¨æ­¤ä¿®æ”¹</button>
            </div>
        `).join('');
    }
    
    function showSaveModificationModal() {
        document.getElementById('saveModificationModal').style.display = 'block';
    }
    
    document.getElementById('saveModificationForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const name = document.getElementById('modificationName').value;
        const description = document.getElementById('modificationDescription').value;
        
        // è·å–å½“å‰çš„è‡ªå®šä¹‰é…ç½®
        const customConfig = {
            'proxy-groups': allGroups.filter(g => {
                // åªä¿å­˜è‡ªå®šä¹‰çš„ä»£ç†ç»„ï¼ˆé€šè¿‡æ£€æŸ¥æ˜¯å¦åœ¨åŸå§‹é…ç½®ä¸­ï¼‰
                return true; // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥åŒºåˆ†
            }),
            'rules': allRules
        };
        
        try {
            const res = await fetch('/api/modifications/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: name,
                    description: description,
                    config: customConfig
                })
            });
            
            const data = await res.json();
            if (data.success) {
                showToast('ä¿®æ”¹å·²ä¿å­˜');
                closeModal('saveModificationModal');
                document.getElementById('saveModificationForm').reset();
                loadModifications();
            } else {
                showToast(data.message, 'error');
            }
        } catch (error) {
            showToast('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
        }
    });
    
    async function applyModification(filename) {
        if (!confirm('ç¡®å®šè¦åº”ç”¨æ­¤ä¿®æ”¹å—ï¼Ÿ')) return;
        
        try {
            const res = await fetch('/api/modifications/apply', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: filename })
            });
            
            const data = await res.json();
            if (data.success) {
                showToast(data.message);
                // é‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®
                loadProxyGroups();
                loadRules();
            } else {
                showToast(data.message, 'error');
            }
        } catch (error) {
            showToast('åº”ç”¨å¤±è´¥: ' + error.message, 'error');
        }
    }
    
    async function deleteModification(filename) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤ä¿®æ”¹å—ï¼Ÿ')) return;
        
        try {
            const res = await fetch('/api/modifications/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: filename })
            });
            
            const data = await res.json();
            if (data.success) {
                showToast('ä¿®æ”¹å·²åˆ é™¤');
                loadModifications();
            } else {
                showToast(data.message, 'error');
            }
        } catch (error) {
            showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
        }
    }
    

    // é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
        }
    });
</script>