<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clash é…ç½®ç®¡ç†å™¨</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Clash é…ç½®ç®¡ç†å™¨</h1>
        
        <!-- è®¢é˜…æ›´æ–°åŒºåŸŸ -->
        <div class="card">
            <h2>ğŸ“¡ è®¢é˜…ç®¡ç†</h2>
            <div class="form-group">
                <input type="text" id="subscriptionUrl" placeholder="è¾“å…¥è®¢é˜… URL">
                <button onclick="refreshSubscription()" class="btn btn-primary">æ›´æ–°è®¢é˜…</button>
                <button onclick="exportConfig()" class="btn btn-success">å¯¼å‡ºé…ç½®</button>
            </div>
        </div>
        
        <!-- ä»£ç†ç»„ç®¡ç† -->
        <div class="card">
            <h2>ğŸ“¦ ä»£ç†ç»„ç®¡ç†</h2>
            <button onclick="showAddGroupModal()" class="btn btn-primary">æ·»åŠ ä»£ç†ç»„</button>
            <div id="proxyGroupsList" class="list-container"></div>
        </div>
        
        <!-- è§„åˆ™ç®¡ç† -->
        <div class="card">
            <h2>ğŸ“‹ è§„åˆ™ç®¡ç†</h2>
            <button onclick="showAddRuleModal()" class="btn btn-primary">æ·»åŠ è§„åˆ™</button>
            <div id="rulesList" class="list-container"></div>
        </div>
    </div>
    
    <!-- ä»£ç†ç»„æ¨¡æ€æ¡† -->
    <div id="groupModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('groupModal')">&times;</span>
            <h3 id="groupModalTitle">æ·»åŠ ä»£ç†ç»„</h3>
            <form id="groupForm">
                <input type="hidden" id="groupOldName">
                <div class="form-group">
                    <label>åç§°:</label>
                    <input type="text" id="groupName" required>
                </div>
                <div class="form-group">
                    <label>ç±»å‹:</label>
                    <select id="groupType" onchange="toggleUrlTestOptions()">
                        <option value="select">select</option>
                        <option value="url-test">url-test</option>
                    </select>
                </div>
                <div id="urlTestOptions" style="display:none;">
                    <div class="form-group">
                        <label>æµ‹è¯• URL:</label>
                        <input type="text" id="groupUrl" value="http://www.gstatic.com/generate_204">
                    </div>
                    <div class="form-group">
                        <label>é—´éš”(ç§’):</label>
                        <input type="number" id="groupInterval" value="300">
                    </div>
                    <div class="form-group">
                        <label>å®¹å·®(ms):</label>
                        <input type="number" id="groupTolerance" value="50">
                    </div>
                </div>
                <div class="form-group">
                    <label>ä»£ç†èŠ‚ç‚¹:</label>
                    <select id="groupProxies" multiple size="10"></select>
                </div>
                <button type="submit" class="btn btn-primary">ä¿å­˜</button>
            </form>
        </div>
    </div>
    
    <!-- è§„åˆ™æ¨¡æ€æ¡† -->
    <div id="ruleModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('ruleModal')">&times;</span>
            <h3 id="ruleModalTitle">æ·»åŠ è§„åˆ™</h3>
            <form id="ruleForm">
                <input type="hidden" id="ruleIndex">
                <div class="form-group">
                    <label>ç±»å‹:</label>
                    <select id="ruleType">
                        <option value="DOMAIN-SUFFIX">DOMAIN-SUFFIX</option>
                        <option value="DOMAIN">DOMAIN</option>
                        <option value="DOMAIN-KEYWORD">DOMAIN-KEYWORD</option>
                        <option value="IP-CIDR">IP-CIDR</option>
                        <option value="IP-CIDR6">IP-CIDR6</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å€¼:</label>
                    <input type="text" id="ruleValue" required placeholder="åŸŸåæˆ–IPæ®µ">
                </div>
                <div class="form-group">
                    <label>ä»£ç†ç»„:</label>
                    <select id="ruleProxy"></select>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="ruleNoResolve"> no-resolve
                    </label>
                </div>
                <button type="submit" class="btn btn-primary">ä¿å­˜</button>
            </form>
        </div>
    </div>
    
    <script>
        let allProxies = [];
        let allGroups = [];
        let allRules = [];
        
        // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
        document.addEventListener('DOMContentLoaded', function() {
            loadProxies();
            loadProxyGroups();
            loadRules();
        });
        
        async function loadProxies() {
            const res = await fetch('/api/proxies');
            const data = await res.json();
            allProxies = data.proxies;
            updateProxySelects();
        }
        
        async function loadProxyGroups() {
            const res = await fetch('/api/proxy-groups');
            const data = await res.json();
            allGroups = data['proxy-groups'];
            renderProxyGroups();
            updateProxySelects();
        }
        
        async function loadRules() {
            const res = await fetch('/api/rules');
            const data = await res.json();
            allRules = data.rules;
            renderRules();
        }
        
        function updateProxySelects() {
            // æ›´æ–°ä»£ç†ç»„ä¸­çš„ä»£ç†é€‰æ‹©
            const groupProxies = document.getElementById('groupProxies');
            groupProxies.innerHTML = allProxies.map(p => 
                `<option value="${p}">${p}</option>`
            ).join('');
            
            // æ›´æ–°è§„åˆ™ä¸­çš„ä»£ç†ç»„é€‰æ‹©
            const ruleProxy = document.getElementById('ruleProxy');
            ruleProxy.innerHTML = allGroups.map(g => 
                `<option value="${g.name}">${g.name}</option>`
            ).join('');
        }
        
        function renderProxyGroups() {
            const container = document.getElementById('proxyGroupsList');
            container.innerHTML = allGroups.map((g, i) => `
                <div class="list-item">
                    <div class="item-info">
                        <strong>${g.name}</strong>
                        <span class="badge">${g.type}</span>
                        <small>ä»£ç†æ•°: ${g.proxies?.length || 0}</small>
                    </div>
                    <div class="item-actions">
                        <button onclick="editGroup(${i})" class="btn btn-sm">ç¼–è¾‘</button>
                        <button onclick="deleteGroup('${g.name}')" class="btn btn-sm btn-danger">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }
        
        function renderRules() {
            const container = document.getElementById('rulesList');
            container.innerHTML = allRules.map((r, i) => {
                const parts = r.split(',');
                return `
                    <div class="list-item">
                        <div class="item-info">
                            <span class="badge">${parts[0]}</span>
                            <code>${parts[1]}</code>
                            <span>â†’ ${parts[2]}</span>
                            ${parts[3] ? '<span class="badge badge-info">no-resolve</span>' : ''}
                        </div>
                        <div class="item-actions">
                            <button onclick="editRule(${i})" class="btn btn-sm">ç¼–è¾‘</button>
                            <button onclick="deleteRule(${i})" class="btn btn-sm btn-danger">åˆ é™¤</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function toggleUrlTestOptions() {
            const type = document.getElementById('groupType').value;
            document.getElementById('urlTestOptions').style.display = 
                type === 'url-test' ? 'block' : 'none';
        }
        
        function showAddGroupModal() {
            document.getElementById('groupModalTitle').textContent = 'æ·»åŠ ä»£ç†ç»„';
            document.getElementById('groupForm').reset();
            document.getElementById('groupOldName').value = '';
            toggleUrlTestOptions();
            document.getElementById('groupModal').style.display = 'block';
        }
        
        function editGroup(index) {
            const g = allGroups[index];
            document.getElementById('groupModalTitle').textContent = 'ç¼–è¾‘ä»£ç†ç»„';
            document.getElementById('groupOldName').value = g.name;
            document.getElementById('groupName').value = g.name;
            document.getElementById('groupType').value = g.type;
            document.getElementById('groupUrl').value = g.url || '';
            document.getElementById('groupInterval').value = g.interval || 300;
            document.getElementById('groupTolerance').value = g.tolerance || 50;
            
            // é€‰æ‹©å·²é…ç½®çš„ä»£ç†
            const proxiesSelect = document.getElementById('groupProxies');
            Array.from(proxiesSelect.options).forEach(opt => {
                opt.selected = g.proxies?.includes(opt.value);
            });
            
            toggleUrlTestOptions();
            document.getElementById('groupModal').style.display = 'block';
        }
        
        function showAddRuleModal() {
            document.getElementById('ruleModalTitle').textContent = 'æ·»åŠ è§„åˆ™';
            document.getElementById('ruleForm').reset();
            document.getElementById('ruleIndex').value = '';
            document.getElementById('ruleModal').style.display = 'block';
        }
        
        function editRule(index) {
            const r = allRules[index].split(',');
            document.getElementById('ruleModalTitle').textContent = 'ç¼–è¾‘è§„åˆ™';
            document.getElementById('ruleIndex').value = index;
            document.getElementById('ruleType').value = r[0];
            document.getElementById('ruleValue').value = r[1];
            document.getElementById('ruleProxy').value = r[2];
            document.getElementById('ruleNoResolve').checked = r[3] === 'no-resolve';
            document.getElementById('ruleModal').style.display = 'block';
        }
        
        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }
        
        // ä»£ç†ç»„è¡¨å•æäº¤
        document.getElementById('groupForm').onsubmit = async function(e) {
            e.preventDefault();
            const data = {
                name: document.getElementById('groupName').value,
                old_name: document.getElementById('groupOldName').value,
                type: document.getElementById('groupType').value,
                proxies: Array.from(document.getElementById('groupProxies').selectedOptions).map(o => o.value)
            };
            
            if (data.type === 'url-test') {
                data.url = document.getElementById('groupUrl').value;
                data.interval = parseInt(document.getElementById('groupInterval').value);
                data.tolerance = parseInt(document.getElementById('groupTolerance').value);
            }
            
            const url = data.old_name ? '/api/proxy-groups/update' : '/api/proxy-groups/add';
            const res = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            const result = await res.json();
            alert(result.message);
            if (result.success) {
                closeModal('groupModal');
                loadProxyGroups();
            }
        };
        
        // è§„åˆ™è¡¨å•æäº¤
        document.getElementById('ruleForm').onsubmit = async function(e) {
            e.preventDefault();
            const data = {
                type: document.getElementById('ruleType').value,
                value: document.getElementById('ruleValue').value,
                proxy: document.getElementById('ruleProxy').value,
                no_resolve: document.getElementById('ruleNoResolve').checked
            };
            
            const index = document.getElementById('ruleIndex').value;
            if (index !== '') {
                data.index = parseInt(index);
            }
            
            const url = index !== '' ? '/api/rules/update' : '/api/rules/add';
            const res = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            const result = await res.json();
            alert(result.message);
            if (result.success) {
                closeModal('ruleModal');
                loadRules();
            }
        };
        
        async function deleteGroup(name) {
            if (!confirm('ç¡®å®šåˆ é™¤è¯¥ä»£ç†ç»„ï¼Ÿ')) return;
            const res = await fetch('/api/proxy-groups/delete', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name})
            });
            const result = await res.json();
            alert(result.message);
            loadProxyGroups();
        }
        
        async function deleteRule(index) {
            if (!confirm('ç¡®å®šåˆ é™¤è¯¥è§„åˆ™ï¼Ÿ')) return;
            const res = await fetch('/api/rules/delete', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({index})
            });
            const result = await res.json();
            alert(result.message);
            loadRules();
        }
        
        async function refreshSubscription() {
            const url = document.getElementById('subscriptionUrl').value;
            if (!url) {
                alert('è¯·è¾“å…¥è®¢é˜… URL');
                return;
            }
            const res = await fetch('/api/config/refresh', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({subscription_url: url})
            });
            const result = await res.json();
            alert(result.message);
            if (result.success) {
                loadProxies();
                loadProxyGroups();
                loadRules();
            }
        }
        
        async function exportConfig() {
            const res = await fetch('/api/config/export');
            const data = await res.json();
            const blob = new Blob([data.config], {type: 'text/yaml'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'config.yaml';
            a.click();
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>